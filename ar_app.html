<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Art Viewer</title>
    
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 { text-align: center; margin-bottom: 30px; }
        
        .section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .hidden { display: none !important; }
        
        input, button {
            background: #3d3d3d;
            color: white;
            border: 1px solid #555;
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background: #4a4a4a;
            cursor: pointer;
        }
        
        button:hover { background: #5a5a5a; }
        
        #ar-container {
            width: 100%;
            height: 400px;
            background: #000;
            border: 2px solid #555;
            border-radius: 8px;
            position: relative;
        }
        
        .artwork-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .artwork-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .artwork-info { flex: 1; }
        
        .delete-btn {
            background: #d63031 !important;
            color: white;
            border: none;
            padding: 8px 12px;
        }
        
        .delete-btn:hover { background: #a4161a !important; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .success { background: #2d7d32; }
        .error { background: #c62828; }
        
        .ar-instructions {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        #json-output {
            width: 100%;
            height: 200px;
            background: #1a1a1a;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #555;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AR Art Viewer</h1>
        
        <!-- Admin Login -->
        <div id="login-section" class="section">
            <h2>Admin Login</h2>
            <input type="password" id="admin-password" placeholder="Enter admin password">
            <button onclick="login()">Login</button>
            <div id="login-error" class="status error hidden">Incorrect password</div>
        </div>
        
        <!-- Admin Panel -->
        <div id="admin-panel" class="section hidden">
            <h2>Admin Panel</h2>
            
            <h3>Add Artwork</h3>
            <input type="file" id="image-input" accept="image/*">
            <input type="url" id="vimeo-input" placeholder="Vimeo URL (e.g., https://vimeo.com/123456789)">
            <button onclick="addArtwork()">Add Artwork</button>
            <div id="upload-status"></div>
            
            <h3>Current Artworks</h3>
            <div id="artworks-list"></div>
            
            <div id="json-section" class="hidden">
                <h3>JSON for GitHub</h3>
                <p>Copy this JSON to your artworks.json file:</p>
                <textarea id="json-output" readonly></textarea>
                <button onclick="copyJSON()">Copy to Clipboard</button>
            </div>
        </div>
        
        <!-- AR Viewer -->
        <div class="section">
            <h2>AR Camera</h2>
            <div class="ar-instructions">
                <p>Point your camera at any artwork to see the video overlay</p>
                <p>Available artworks: <span id="artwork-count">0</span></p>
            </div>
            
            <button id="start-ar" onclick="startAR()">Start AR Camera</button>
            <button id="stop-ar" onclick="stopAR()" class="hidden">Stop AR</button>
            
            <div id="ar-container" class="hidden"></div>
            <div id="ar-status"></div>
        </div>
    </div>

    <script>
        // Global state
        const ADMIN_PASSWORD = "artadmin123";
        let artworks = [];
        let arActive = false;
        
        // Initialize app
        async function init() {
            console.log("Initializing AR Art Viewer");
            await loadArtworks();
            updateArtworkCount();
        }
        
        // Admin functions
        function login() {
            const password = document.getElementById('admin-password').value;
            const loginSection = document.getElementById('login-section');
            const adminPanel = document.getElementById('admin-panel');
            const errorDiv = document.getElementById('login-error');
            
            if (password === ADMIN_PASSWORD) {
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadArtworksList();
                document.getElementById('admin-password').value = '';
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.classList.remove('hidden');
            }
        }
        
        function addArtwork() {
            const imageInput = document.getElementById('image-input');
            const vimeoInput = document.getElementById('vimeo-input');
            const statusDiv = document.getElementById('upload-status');
            
            if (!imageInput.files[0] || !vimeoInput.value.trim()) {
                showStatus('Please select an image and enter a Vimeo URL', 'error');
                return;
            }
            
            const vimeoMatch = vimeoInput.value.match(/vimeo\.com\/(\d+)/);
            if (!vimeoMatch) {
                showStatus('Invalid Vimeo URL format', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const artwork = {
                    id: Date.now(),
                    name: imageInput.files[0].name,
                    image: e.target.result,
                    vimeoUrl: vimeoInput.value.trim(),
                    vimeoId: vimeoMatch[1],
                    created: new Date().toLocaleDateString()
                };
                
                artworks.push(artwork);
                saveArtworks();
                loadArtworksList();
                generateJSON();
                
                imageInput.value = '';
                vimeoInput.value = '';
                showStatus('Artwork added successfully', 'success');
                updateArtworkCount();
            };
            
            reader.readAsDataURL(imageInput.files[0]);
        }
        
        function deleteArtwork(id) {
            artworks = artworks.filter(artwork => artwork.id !== id);
            saveArtworks();
            loadArtworksList();
            generateJSON();
            showStatus('Artwork deleted', 'success');
            updateArtworkCount();
        }
        
        function loadArtworksList() {
            const listDiv = document.getElementById('artworks-list');
            
            if (artworks.length === 0) {
                listDiv.innerHTML = '<p style="color: #888;">No artworks uploaded yet.</p>';
                return;
            }
            
            let html = '';
            artworks.forEach(artwork => {
                html += `
                    <div class="artwork-item">
                        <img src="${artwork.image}" alt="${artwork.name}" class="artwork-preview">
                        <div class="artwork-info">
                            <strong>${artwork.name}</strong><br>
                            <small>Vimeo ID: ${artwork.vimeoId}</small><br>
                            <small>Created: ${artwork.created}</small>
                        </div>
                        <button class="delete-btn" onclick="deleteArtwork(${artwork.id})">Delete</button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        function generateJSON() {
            if (artworks.length === 0) {
                document.getElementById('json-section').classList.add('hidden');
                return;
            }
            
            const jsonOutput = document.getElementById('json-output');
            const jsonSection = document.getElementById('json-section');
            
            jsonOutput.value = JSON.stringify(artworks, null, 2);
            jsonSection.classList.remove('hidden');
        }
        
        function copyJSON() {
            const jsonOutput = document.getElementById('json-output');
            jsonOutput.select();
            
            try {
                document.execCommand('copy');
                showStatus('JSON copied to clipboard', 'success');
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(jsonOutput.value).then(() => {
                        showStatus('JSON copied to clipboard', 'success');
                    }).catch(() => {
                        showStatus('Copy failed - please select and copy manually', 'error');
                    });
                } else {
                    showStatus('Copy failed - please select and copy manually', 'error');
                }
            }
        }
        
        // Data persistence
        function saveArtworks() {
            try {
                localStorage.setItem('ar-artworks', JSON.stringify(artworks));
            } catch (error) {
                console.error('Failed to save artworks:', error);
            }
        }
        
        async function loadArtworks() {
            // Try GitHub first
            try {
                const response = await fetch('./artworks.json?t=' + Date.now());
                if (response.ok) {
                    const githubArtworks = await response.json();
                    if (Array.isArray(githubArtworks) && githubArtworks.length > 0) {
                        artworks = githubArtworks;
                        console.log('Loaded artworks from GitHub:', artworks.length);
                        return;
                    }
                }
            } catch (error) {
                console.log('GitHub load failed, trying localStorage');
            }
            
            // Fallback to localStorage
            try {
                const saved = localStorage.getItem('ar-artworks');
                if (saved) {
                    artworks = JSON.parse(saved);
                    console.log('Loaded artworks from localStorage:', artworks.length);
                }
            } catch (error) {
                console.error('Failed to load artworks:', error);
                artworks = [];
            }
        }
        
        // AR functions
        async function startAR() {
            const arContainer = document.getElementById('ar-container');
            const startBtn = document.getElementById('start-ar');
            const stopBtn = document.getElementById('stop-ar');
            const statusDiv = document.getElementById('ar-status');
            
            if (artworks.length === 0) {
                statusDiv.innerHTML = '<div class="status error">No artworks available. Add some in the admin panel first.</div>';
                return;
            }
            
            // Test camera permissions
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">Camera permission required. Please allow camera access.</div>';
                return;
            }
            
            arContainer.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="status">Initializing AR...</div>';
            
            try {
                await createARScene(arContainer);
                arActive = true;
                statusDiv.innerHTML = '<div class="status success">AR active - point camera at artworks</div>';
            } catch (error) {
                console.error('AR initialization failed:', error);
                statusDiv.innerHTML = '<div class="status error">AR failed to start: ' + error.message + '</div>';
                stopAR();
            }
        }
        
        async function createARScene(container) {
            // Create simple AR scene with HIRO marker for testing
            const sceneHTML = `
                <a-scene
                    embedded
                    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
                    vr-mode-ui="enabled: false"
                    loading-screen="enabled: false;"
                    style="width: 100%; height: 100%;">
                    
                    <a-marker preset="hiro" smooth="true">
                        <a-box position="0 0.5 0" material="color: red;" 
                               animation="property: rotation; to: 0 360 0; loop: true; dur: 2000;"></a-box>
                        <a-text value="AR Working!" position="0 1 0" color="white" align="center"></a-text>
                    </a-marker>
                    
                    <a-entity camera></a-entity>
                </a-scene>
            `;
            
            container.innerHTML = sceneHTML;
            
            // Wait for scene to initialize
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const scene = container.querySelector('a-scene');
                    if (scene) {
                        scene.addEventListener('renderstart', () => {
                            console.log('AR scene started');
                            resolve();
                        });
                    } else {
                        reject(new Error('Failed to create AR scene'));
                    }
                }, 1000);
            });
        }
        
        function stopAR() {
            const arContainer = document.getElementById('ar-container');
            const startBtn = document.getElementById('start-ar');
            const stopBtn = document.getElementById('stop-ar');
            const statusDiv = document.getElementById('ar-status');
            
            arContainer.classList.add('hidden');
            arContainer.innerHTML = '';
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            statusDiv.innerHTML = '';
            arActive = false;
            
            console.log('AR stopped');
        }
        
        // Utility functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }
        
        function updateArtworkCount() {
            document.getElementById('artwork-count').textContent = artworks.length;
        }
        
        // Event listeners
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (arActive) stopAR();
                
                // Hide admin panel
                const adminPanel = document.getElementById('admin-panel');
                const loginSection = document.getElementById('login-section');
                if (!adminPanel.classList.contains('hidden')) {
                    adminPanel.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    document.getElementById('login-error').classList.add('hidden');
                }
            }
        });
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && arActive) {
                stopAR();
            }
        });
        
        // Initialize when page loads
        window.addEventListener('load', init);
        
        console.log('AR Art Viewer loaded');
    </script>
</body>
</html>
