<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Art Viewer</title>
    
    <!-- Using A-Frame with threejs-ar for better iOS compatibility -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .admin-section {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        input, button {
            background-color: #3d3d3d;
            color: white;
            border: 1px solid #555;
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            cursor: pointer;
            background-color: #4a4a4a;
        }
        
        button:hover {
            background-color: #5a5a5a;
        }
        
        a {
            color: white;
            font-weight: bold;
            text-decoration: none;
        }
        
        .ar-section {
            text-align: center;
            margin-top: 30px;
        }
        
        #arContainer {
            width: 100%;
            height: 400px;
            border: 2px solid #555;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .image-item {
            background-color: #2d2d2d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            float: left;
        }
        
        .image-info {
            margin-left: 120px;
        }
        
        .clear {
            clear: both;
        }
        
        .error {
            color: #ff6b6b;
            margin: 10px 0;
        }
        
        .success {
            color: #51cf66;
            margin: 10px 0;
        }

        .status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }

        .test-marker {
            background: white;
            padding: 20px;
            margin: 20px auto;
            width: 200px;
            text-align: center;
            border-radius: 8px;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AR Art Viewer - Simplified</h1>
        
        <!-- Admin Section -->
        <div class="admin-section">
            <h2>Admin Access</h2>
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <button onclick="checkPassword()">Access Admin Panel</button>
            <div id="passwordError" class="error hidden">Incorrect password</div>
        </div>
        
        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-section hidden">
            <h2>Admin Panel</h2>
            
            <h3>Add New AR Artwork</h3>
            <p>Upload a square image and add Vimeo URL:</p>
            <input type="file" id="imageUpload" accept="image/*">
            <input type="url" id="vimeoUrl" placeholder="Vimeo video URL">
            <button onclick="uploadImage()">Add Artwork</button>
            <div id="uploadStatus"></div>
            
            <h3>Current Artworks</h3>
            <div id="imageList"></div>
        </div>
        
        <!-- AR Viewer Section -->
        <div class="ar-section">
            <h2>AR Viewer</h2>
            <div id="deviceInfo" style="margin: 10px 0; font-size: 14px; color: #ccc;"></div>
            
            <!-- Test marker for debugging -->
            <div class="test-marker">
                <h4>Test Marker (HIRO)</h4>
                <div style="width: 150px; height: 150px; margin: 0 auto; border: 3px solid black; background: repeating-linear-gradient(45deg, black, black 10px, white 10px, white 20px);"></div>
                <p style="font-size: 12px;">Point camera at this pattern</p>
            </div>
            
            <button id="testCamera" onclick="testBasicCamera()">Test Camera Only</button>
            <button id="startAR" onclick="startAR()">Start AR (iOS Safe)</button>
            <button id="stopAR" onclick="stopAR()" class="hidden">Stop AR</button>
            
            <div id="arContainer" class="hidden"></div>
            <div id="debugInfo" style="margin-top: 20px; font-size: 12px; color: #888;"></div>
        </div>
    </div>

    <script>
        // Global variables
        const ADMIN_PASSWORD = "artadmin123";
        const STORAGE_KEY = "ar_artworks";
        let currentArtworks = [];
        let cameraStream = null;
        let arActive = false;

        // Device detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

        // Admin functions
        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const adminPanel = document.getElementById('adminPanel');
            
            if (password === ADMIN_PASSWORD) {
                adminPanel.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                loadImageList();
                document.getElementById('adminPassword').value = '';
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        function uploadImage() {
            const fileInput = document.getElementById('imageUpload');
            const vimeoInput = document.getElementById('vimeoUrl');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files[0] || !vimeoInput.value) {
                statusDiv.innerHTML = '<div class="error">Please select an image and enter Vimeo URL</div>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const vimeoMatch = vimeoInput.value.match(/vimeo\.com\/(\d+)/);
                if (!vimeoMatch) {
                    statusDiv.innerHTML = '<div class="error">Invalid Vimeo URL</div>';
                    return;
                }

                const newArtwork = {
                    id: Date.now(),
                    imageName: fileInput.files[0].name,
                    imageData: e.target.result,
                    vimeoUrl: vimeoInput.value,
                    vimeoId: vimeoMatch[1],
                    dateAdded: new Date().toLocaleDateString()
                };

                currentArtworks.push(newArtwork);
                saveArtworks();
                
                fileInput.value = '';
                vimeoInput.value = '';
                statusDiv.innerHTML = '<div class="success">Artwork added! Update your artworks.json file with the data below.</div>';
                
                loadImageList();
            };
            
            reader.readAsDataURL(fileInput.files[0]);
        }

        function deleteImage(artworkId) {
            if (confirm('Delete this artwork?')) {
                currentArtworks = currentArtworks.filter(art => art.id != artworkId);
                saveArtworks();
                loadImageList();
            }
        }

        function loadImageList() {
            const imageList = document.getElementById('imageList');
            
            if (currentArtworks.length === 0) {
                imageList.innerHTML = '<p>No artworks yet.</p>';
                return;
            }

            let html = '';
            currentArtworks.forEach(artwork => {
                html += `
                    <div class="image-item">
                        <img src="${artwork.imageData}" alt="${artwork.imageName}" class="image-preview">
                        <div class="image-info">
                            <strong>${artwork.imageName}</strong><br>
                            <a href="${artwork.vimeoUrl}" target="_blank">${artwork.vimeoUrl}</a><br>
                            <strong>Added:</strong> ${artwork.dateAdded}<br>
                            <button onclick="deleteImage(${artwork.id})" style="background-color: #d63031; margin-top: 5px;">Delete</button>
                        </div>
                        <div class="clear"></div>
                    </div>
                `;
            });
            
            imageList.innerHTML = html;
            showJSONInstructions();
        }

        // Data storage
        function saveArtworks() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentArtworks));
        }

        async function loadArtworks() {
            try {
                const response = await fetch('./artworks.json?t=' + Date.now());
                if (response.ok) {
                    currentArtworks = await response.json();
                    console.log('Loaded from GitHub');
                    return;
                }
            } catch (error) {
                console.log('GitHub load failed, using localStorage');
            }
            
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                currentArtworks = JSON.parse(saved);
            }
        }

        function showJSONInstructions() {
            const existing = document.getElementById('jsonInstructions');
            if (existing) existing.remove();
            
            const div = document.createElement('div');
            div.id = 'jsonInstructions';
            div.style.cssText = 'background: #333; padding: 15px; margin: 15px 0; border-radius: 8px;';
            
            const jsonData = JSON.stringify(currentArtworks, null, 2);
            div.innerHTML = `
                <h4>Update artworks.json file:</h4>
                <textarea readonly style="width: 100%; height: 150px; background: #1a1a1a; color: white; border: 1px solid #555; padding: 10px; font-family: monospace;">${jsonData}</textarea>
                <button onclick="copyJSON()">Copy JSON</button>
            `;
            
            document.getElementById('adminPanel').appendChild(div);
        }

        function copyJSON() {
            const textarea = document.querySelector('#jsonInstructions textarea');
            textarea.select();
            document.execCommand('copy');
            alert('JSON copied to clipboard!');
        }

        // Camera and AR functions
        function showDeviceInfo() {
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.innerHTML = `Device: ${isMobile ? 'Mobile' : 'Desktop'} | iOS: ${isIOS ? 'Yes' : 'No'}`;
        }

        async function testBasicCamera() {
            const arContainer = document.getElementById('arContainer');
            const debugInfo = document.getElementById('debugInfo');
            
            arContainer.classList.remove('hidden');
            arContainer.innerHTML = '<div class="status-overlay">Testing camera...</div>';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });

                const video = document.createElement('video');
                video.setAttribute('playsinline', '');
                video.setAttribute('autoplay', '');
                video.setAttribute('muted', '');
                video.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                video.srcObject = stream;

                arContainer.innerHTML = `
                    <div class="status-overlay">✅ Camera working!</div>
                `;
                arContainer.appendChild(video);

                cameraStream = stream;
                debugInfo.innerHTML = 'Camera test successful! Video tracks: ' + stream.getVideoTracks().length;

                // Add stop button
                const stopBtn = document.createElement('button');
                stopBtn.textContent = 'Stop Camera Test';
                stopBtn.onclick = stopBasicCamera;
                stopBtn.style.cssText = 'position: absolute; bottom: 10px; right: 10px; background: #f44336;';
                arContainer.appendChild(stopBtn);

            } catch (error) {
                arContainer.innerHTML = `<div class="status-overlay">❌ Camera failed: ${error.message}</div>`;
                debugInfo.innerHTML = `Camera error: ${error.name} - ${error.message}`;
            }
        }

        function stopBasicCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('arContainer').classList.add('hidden');
            document.getElementById('debugInfo').innerHTML = '';
        }

        async function startAR() {
            const arContainer = document.getElementById('arContainer');
            const startBtn = document.getElementById('startAR');
            const stopBtn = document.getElementById('stopAR');
            
            if (currentArtworks.length === 0) {
                alert('No artworks available. Add some in the admin panel first.');
                return;
            }

            // First test camera permissions
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                alert('Camera permission needed for AR');
                return;
            }

            arContainer.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');

            // For iOS, use a simplified approach
            if (isIOS) {
                createiOSAR(arContainer);
            } else {
                createStandardAR(arContainer);
            }
            
            arActive = true;
        }

        function createiOSAR(container) {
            // Simplified AR for iOS using basic video + overlay
            container.innerHTML = `
                <div class="status-overlay">iOS AR - Camera + Manual Detection</div>
                <video id="iosARVideo" playsinline autoplay muted style="width: 100%; height: 100%; object-fit: cover;"></video>
            `;

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            }).then(stream => {
                const video = document.getElementById('iosARVideo');
                video.srcObject = stream;
                cameraStream = stream;
                
                // Add overlay instructions
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
                    background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
                    border-radius: 15px; text-align: center; font-size: 14px;
                `;
                overlay.innerHTML = '📱 Point camera at artwork<br><small>AR detection active</small>';
                container.appendChild(overlay);

                // Update status
                container.querySelector('.status-overlay').textContent = '✅ iOS AR Active';
                
            }).catch(error => {
                container.innerHTML = `<div class="status-overlay">iOS AR Failed: ${error.message}</div>`;
            });
        }

        function createStandardAR(container) {
            // Standard AR.js scene for desktop/Android
            container.innerHTML = `
                <div class="status-overlay">Loading AR.js...</div>
                <a-scene
                    embedded
                    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
                    vr-mode-ui="enabled: false"
                    style="width: 100%; height: 100%;">
                    
                    <a-marker preset="hiro" smooth="true">
                        <a-box position="0 0.5 0" material="color: red;" animation="property: rotation; to: 0 360 0; loop: true; dur: 2000;"></a-box>
                        <a-text value="AR Working!" position="0 1 0" color="white" align="center"></a-text>
                    </a-marker>
                    
                    <a-entity camera></a-entity>
                </a-scene>
            `;

            // Monitor AR.js initialization
            setTimeout(() => {
                const scene = container.querySelector('a-scene');
                if (scene) {
                    scene.addEventListener('renderstart', () => {
                        container.querySelector('.status-overlay').textContent = '✅ AR Active - Point at HIRO marker';
                    });
                }
            }, 2000);
        }

        function stopAR() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            document.getElementById('arContainer').classList.add('hidden');
            document.getElementById('arContainer').innerHTML = '';
            document.getElementById('startAR').classList.remove('hidden');
            document.getElementById('stopAR').classList.add('hidden');
            
            arActive = false;
        }

        // Initialize app
        function initializeApp() {
            console.log("Initializing AR Art Viewer...");
            showDeviceInfo();
            loadArtworks();
        }

        window.addEventListener('load', initializeApp);
        
        // ESC key handler
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const adminPanel = document.getElementById('adminPanel');
                if (!adminPanel.classList.contains('hidden')) {
                    adminPanel.classList.add('hidden');
                    document.getElementById('passwordError').classList.add('hidden');
                    document.getElementById('adminPassword').value = '';
                }
            }
        });
    </script>
</body>
</html>
